#include <Arduino.h>

#define VOICE1_PIN 2
#define VOICE2_PIN 3
#define VOICE3_PIN 4

// Note frequencies (Hz) - C4 through C7
const uint16_t NOTES[] = {
  0,      // 0 = Silence
  262,    // C4
  277,    // C#4
  294,    // D4
  311,    // D#4
  330,    // E4
  349,    // F4
  370,    // F#4
  392,    // G4
  415,    // G#4
  440,    // A4
  466,    // A#4
  494,    // B4
  523,    // C5
  554,    // C#5
  587,    // D5
  622,    // D#5
  659,    // E5
  698,    // F5
  740,    // F#5
  784,    // G5
  831,    // G#5
  880,    // A5
  932,    // A#5
  988,    // B5
  1047,   // C6
  1109,   // C#6
  1175,   // D6
  1245,   // D#6
  1319,   // E6
  1397,   // F6
  1480,   // F#6
  1568,   // G6
  1661,   // G#6
  1760,   // A6
  1865,   // A#6
  1976,   // B6
  2093    // C7
};

// Your Pokemon melodies
const char voice1_melody[]
 PROGMEM = "16A5 16GS5 16G5 16FS5 16A5 16F5 16FS5 16F5 16A5 16E5 16F5 16E5 16A5 16DS5 16E5 16DS5 16A5 16D5 16DS5 16D5 16A5 16CS5 16D5 16CS5 16A5 16C5 16CS5 16C5 16A5 16B4 16C5 16B4 8B5 8S 4S 2S 1S 8B5 8S 4S 2S 2S 4S 8A5 8S 8B4 4S 8CS5 4S 8D5 8S 8B4 8CS5 8S 8D5 4S 8A5 8AS5 8B5 4S 8CS6 4S 8D6 8S 8B5 8CS6 8S 8D6 4S 8A5 8S 4B4 8B4 2FS4 8S 4S 4B4 4FS4 4B4 1C5 1S 4B4 8B4 2FS4 8S 4S 4B4 4FS4 4B4 1A4 1S 1G4 2D5 2G4 1A4 1S 1G4 2E5 2FS5 1E5 4G5 8A5 8G5 8FS5 8E5 8D5 8E5 1FS5 1FS5 1G5 4G5 8A5 8G5 8G5 8FS5 8E5 8FS5 1GS5 1GS5 1A5 2CS6 2E6 4D6 4A5 8C6 8B5 1B5 4B5 2B5 4D6 4A5 8AS5 8F6 2F6 4F6 1G6 1E6 2E6 4E6 8E6 8B4 4C5 8C5 8A4 2A4 4S 4C5 4A4 4C5 4AS4 8AS4 2F5 4S 8S 4AS4 4F5 4D5 4C5 8C5 8A4 2A4 4S 4A4 8E5 8D5 8C5 8E5 8D5 4AS4 8F5 2F5 4G5 8G5 4F5 8F5 4D5 1F5 1E5 1D5 1E5 1F6 1E6 1G6 1F6 8E5 4S 8E5 4S 8E5 8S 8E5 4S 8E5 4S 8E5 8S 4A4 4B4 8G4 8A4 2A4 8B4 8CS5 8E5 8D5 8CS5 8B4 1AS4 8S 8AS4 8C5 8F5 8E5 8D5 8C5 8AS4 1B4 8S 8B4 8CS5 8G5 8FS5 8E5 8D5 8B4 1C5 2E5 2G5 4B4 8B4 2FS4 8S 4S 4B4 4FS4 4B4 1C5 1S 4B4 8B4 2FS4 8S 4S 4B4 4FS4 4B4 1A4 1S 1G4 2D5 2G4 1A4 1S 1G4 2E5 2FS5 1E5 4G5 8A5 8G5 8FS5 8E5 8D5 8E5 1FS5 1FS5 1G5 4G5 8A5 8G5 8G5 8FS5 8E5 8FS5 1GS5 1GS5 1A5 2CS6 2E6 4D6 4A5 8C6 8B5 1B5 4B5 2B5 4D6 4A5 8AS5 8F6 2F6 4F6 1G6 1E6 2E6 4E6 8E6 8B4 4C5 8C5 8A4 2A4 4S 4C5 4A4 4C5 4AS4 8AS4 2F5 4S 8S 4AS4 4F5 4D5 4C5 8C5 8A4 2A4 4S 4A4 8E5 8D5 8C5 8E5 8D5 4AS4 8F5 2F5 4G5 8G5 4F5 8F5 4D5 1F5 1E5 1D5 1E5 1F6 1E6 1G6 1F6 8E5 4S 8E5 4S 8E5 8S 8E5 4S 8E5 4S 8E5 8S 4A4 4B4 8G4 8A4 2A4 8B4 8CS5 8E5 8D5 8CS5 8B4 1AS4 8S 8AS4 8C5 8F5 8E5 8D5 8C5 8AS4 1B4 8S 8B4 8CS5 8G5 8FS5 8E5 8D5 8B4 1C5 2E5 2G5 1D5 X";

const char voice2_melody[]
 PROGMEM = "2S 16F4 16E4 16F4 16E4 16DS4 16D4 16DS4 16D4 16CS4 16D4 16CS4 16C4 16B3 16C4 16B3 16AS3 16B3 16AS3 16A3 16AS3 16A3 16GS3 16A3 16GS3 8D4 4S 8E4 4S 8F4 8S 8D4 8E4 8S 8F4 4S 8C4 8S 8D4 4S 8E4 4S 8F4 8S 8D4 8E4 8S 8F4 4S 8C4 8CS4 8D4 4E4 8CS4 4D4 4B3 4FS3 8E4 4D4 8CS4 8D4 8E4 2F4 16C4 16CS4 16D4 16DS4 16E4 16DS4 16D4 16C4 16C4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16CS4 8D4 4E4 8CS4 4D4 4B3 4FS3 8E4 4D4 8CS4 8B3 8CS4 2D4 2CS4 2B3 2CS4 8D4 8CS4 8B3 8A3 8G3 8S 8D4 8CS4 8B3 8A3 8G3 8S 8D4 8CS4 8B3 8CS4 4E4 16G3 16A3 16B3 16CS4 4D4 16FS3 16G3 16A3 16B3 4CS4 16G3 16A3 16B3 16CS4 4D4 16FS3 16G3 16A3 16B3 8D4 8CS4 8B3 8A3 8G3 8S 8D4 8CS4 8B3 8A3 8B3 8G3 8D4 8E4 8FS4 8G4 8A4 8B4 8A4 8G4 8A4 8S 8A4 8B4 8A4 8G4 8FS4 8G4 8A4 8E4 8G4 8FS4 16B3 16C4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16A4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16CS4 16C4 16C4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16A4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16CS4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16F5 16E5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16A4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16F5 16FS5 16F5 16E5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16F5 4A4 4D5 8A4 16D4 16E4 16F4 16G4 16A4 16AS4 8B4 8C5 8A4 8C5 8G4 8B4 8F4 8G4 8A4 8C5 8D5 8S 4A4 4C5 8D5 16F4 16G4 16A4 16AS4 16C5 16D5 8E5 8F5 8D5 8F5 8D5 8F5 8D5 8F5 8E5 8F5 8E5 8F5 8E5 8F5 8E5 8F5 8C4 8A3 8E4 8C4 8A3 8E4 8C4 8A3 8C4 8E4 8D4 8AS3 8F4 8D4 8AS3 8F4 8D4 8AS3 8D4 8F4 8C4 8A3 8E4 8C4 8A3 8E4 8C4 8A3 8C4 8E4 8D4 8AS3 8F4 8D4 8AS3 8F4 8D4 8AS3 8D4 8F4 1D4 1C4 1AS3 2G3 4G3 16D4 16E4 16G4 16C5 2D5 2F5 2AS4 2C5 2D5 2E5 2F5 2G5 8AS4 4S 8AS4 4S 8AS4 8S 8A4 4S 8A4 4S 8A4 8S 8C5 4S 8C5 4S 8C5 8S 8AS4 4S 8AS4 4S 8A4 8S 8C4 4D4 8B3 4CS4 8S 16CS4 16D4 16E4 16S 16D4 16S 16B3 16S 16CS4 16S 2S 16D4 16DS4 16E4 16F4 16F4 16E4 16DS4 16D4 16CS4 16S 4S 16CS4 16D4 16E4 16S 16F4 16S 16E4 16S 16D4 16S 8D4 8E4 8F4 8G4 16DS4 16E4 16F4 16FS4 16FS4 16F4 16E4 16DS4 16D4 16S 2S 8FS4 4E4 8DS4 8E4 8FS4 8GS4 2E4 2FS4 2G4 4C5 16FS4 16G4 16GS4 16A4 8D4 4E4 8CS4 4D4 4B3 4FS3 8E4 4D4 8CS4 8D4 8E4 2F4 16C4 16CS4 16D4 16DS4 16E4 16DS4 16D4 16C4 16C4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16CS4 8D4 4E4 8CS4 4D4 4B3 4FS3 8E4 4D4 8CS4 8B3 8CS4 2D4 2CS4 2B3 2CS4 8D4 8CS4 8B3 8A3 8G3 8S 8D4 8CS4 8B3 8A3 8G3 8S 8D4 8CS4 8B3 8CS4 4E4 16G3 16A3 16B3 16CS4 4D4 16FS3 16G3 16A3 16B3 4CS4 16G3 16A3 16B3 16CS4 4D4 16FS3 16G3 16A3 16B3 8D4 8CS4 8B3 8A3 8G3 8S 8D4 8CS4 8B3 8A3 8B3 8G3 8D4 8E4 8FS4 8G4 8A4 8B4 8A4 8G4 8A4 8S 8A4 8B4 8A4 8G4 8FS4 8G4 8A4 8E4 8G4 8FS4 16B3 16C4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16A4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16CS4 16C4 16C4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16A4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16CS4 16CS4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16F5 16E5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16A4 16GS4 16G4 16FS4 16F4 16E4 16DS4 16D4 16D4 16DS4 16E4 16F4 16FS4 16G4 16GS4 16A4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16F5 16FS5 16F5 16E5 16DS5 16D5 16CS5 16C5 16B4 16AS4 16B4 16C5 16CS5 16D5 16DS5 16E5 16F5 4A4 4D5 8A4 16D4 16E4 16F4 16G4 16A4 16AS4 8B4 8C5 8A4 8C5 8G4 8B4 8F4 8G4 8A4 8C5 8D5 8S 4A4 4C5 8D5 16F4 16G4 16A4 16AS4 16C5 16D5 8E5 8F5 8D5 8F5 8D5 8F5 8D5 8F5 8E5 8F5 8E5 8F5 8E5 8F5 8E5 8F5 8C4 8A3 8E4 8C4 8A3 8E4 8C4 8A3 8C4 8E4 8D4 8AS3 8F4 8D4 8AS3 8F4 8D4 8AS3 8D4 8F4 8C4 8A3 8E4 8C4 8A3 8E4 8C4 8A3 8C4 8E4 8D4 8AS3 8F4 8D4 8AS3 8F4 8D4 8AS3 8D4 8F4 1D4 1C4 1AS3 2G3 4G3 16D4 16E4 16G4 16C5 2D5 2F5 2AS4 2C5 2D5 2E5 2F5 2G5 8AS4 4S 8AS4 4S 8AS4 8S 8A4 4S 8A4 4S 8A4 8S 8C5 4S 8C5 4S 8C5 8S 8AS4 4S 8AS4 4S 8A4 8S 8C4 4D4 8B3 4CS4 8S 16CS4 16D4 16E4 16S 16D4 16S 16B3 16S 16CS4 16S 2S 16D4 16DS4 16E4 16F4 16F4 16E4 16DS4 16D4 16CS4 16S 4S 16CS4 16D4 16E4 16S 16F4 16S 16E4 16S 16D4 16S 8D4 8E4 8F4 8G4 16DS4 16E4 16F4 16FS4 16FS4 16F4 16E4 16DS4 16D4 16S 2S 8FS4 4E4 8DS4 8E4 8FS4 8GS4 2E4 2FS4 2G4 4C5 16FS4 16G4 16GS4 16A4 1B4 X";

const char voice3_melody[] PROGMEM = 
"16B4 16AS4 16A4 16GS4 16A4 16GS4 16G4 16GS4 16G4 16FS4 16F4 16FS4 16F4 16E4 16F4 16E4 16DS4 16E4 16DS4 16D4 16CS4 16D4 16CS4 16C4 16B3 16C4 16B3 16AS3 16A3 16GS3 16A3 16AS3 "
"8B3 8B3 8D4 8E4 8B3 8F4 8E4 8D4 8B3 8B3 8D4 8E4 8B3 8D4 8AS3 8C4 8B3 8B3 8D4 8E4 8B3 8F4 8E4 8D4 8B3 8B3 8D4 8E4 8B3 8D4 8AS3 8C4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8B3 8G4 8C4 8G4 8C4 8G4 8C4 8G4 8C4 8G4 "
"8A4 8G4 8FS4 8E4 8D4 8C4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8B3 8F4 "
"8A3 8E4 8A3 8E4 8A3 8E4 "
"8D4 8CS4 8D4 8CS4 8A3 8GS3 "
"8G3 8D4 8G3 8D4 8G3 8D4 8G3 8D4 "
"8G3 8GS3 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8G3 8D4 8G3 8D4 8G3 8D4 8G3 8D4 "
"8G3 8GS3 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8D4 8CS4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8D4 8E4 8FS4 8E4 8D4 8FS4 "
"8C4 8G4 8C4 8G4 8C4 8G4 8C4 8G4 8C4 8G4 "
"8DS4 8F4 8G4 8F4 8DS4 8G4 "
"8CS4 8GS4 8CS4 8GS4 8CS4 8GS4 8CS4 8GS4 8CS4 8GS4 "
"8E4 8FS4 8GS4 8FS4 8E4 8GS4 "
"8D4 8A4 8D4 8A4 8D4 8A4 8D4 8A4 8D4 8A4 "
"8F4 8G4 8A4 8G4 8F4 8E4 "
"4D4 4A3 "
"8C4 8G4 8B3 8G4 8B3 8G4 8B3 8G4 8B3 8G4 "
"8B3 8G4 "
"4D4 4A3 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"8B3 8E4 8B3 8E4 8B3 8E4 8B3 8E4 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"4AS3 4F4 4AS3 4F4 "
"4AS3 4E4 4AS3 4E4 "
"4AS3 4D4 4AS3 4D4 "
"4AS3 4E4 4AS3 4E4 "
"8A3 8E4 8E4 8A3 8E4 8E4 8A3 8E4 8E4 8A3 8E4 8E4 8A3 8E4 8E4 8B3 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8C4 8G4 8C4 8G4 8C4 8G4 "
"8FS4 8E4 8FS4 8E4 8D4 8C4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8B3 8G4 "
"8C4 8G4 8C4 8G4 8C4 8G4 8C4 8G4 "
"8A4 8G4 8FS4 8E4 8D4 8C4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8B3 8F4 "
"8A3 8E4 8A3 8E4 8A3 8E4 "
"8D4 8CS4 8D4 8CS4 8A3 8GS3 "
"8G3 8D4 8G3 8D4 8G3 8D4 8G3 8D4 "
"8G3 8GS3 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8G3 8D4 8G3 8D4 8G3 8D4 8G3 8D4 "
"8G3 8GS3 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8D4 8CS4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8D4 8E4 8FS4 8E4 8D4 8FS4 "
"8C4 8G4 8C4 8G4 8C4 8G4 8C4 8G4 8C4 8G4 "
"8DS4 8F4 8G4 8F4 8DS4 8G4 "
"8CS4 8GS4 8CS4 8GS4 8CS4 8GS4 8CS4 8GS4 8CS4 8GS4 "
"8E4 8FS4 8GS4 8FS4 8E4 8GS4 "
"8D4 8A4 8D4 8A4 8D4 8A4 8D4 8A4 8D4 8A4 "
"8F4 8G4 8A4 8G4 8F4 8E4 "
"4D4 4A3 "
"8C4 8G4 8B3 8G4 8B3 8G4 8B3 8G4 8B3 8G4 "
"8B3 8G4 "
"4D4 4A3 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"8B3 8E4 8B3 8E4 8B3 8E4 8B3 8E4 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"4AS3 4F4 4AS3 4F4 "
"4AS3 4E4 4AS3 4E4 "
"4AS3 4D4 4AS3 4D4 "
"4AS3 4E4 4AS3 4E4 "
"8A3 8E4 8E4 8A3 8E4 8E4 8A3 8E4 8E4 8A3 8E4 8E4 8A3 8E4 8E4 8B3 "
"8A3 8E4 8A3 8E4 8A3 8E4 8A3 8E4 "
"8AS3 8F4 8AS3 8F4 8AS3 8F4 8AS3 8F4 "
"8B3 8FS4 8B3 8FS4 8B3 8FS4 8B3 8FS4 "
"8C4 8G4 8C4 8G4 8C4 8G4 "
"8FS4 8E4 8FS4 8E4 8D4 8C4 "
"1B3 X";

// Voice structure for polyphonic playback
struct Voice {
  int pin;
  volatile unsigned long nextToggle;
  volatile bool state;
  volatile int frequency;
  const char* melody;
  int position;
  unsigned long noteStart;
  int noteDuration;
  
  Voice(int p, const char* m) : pin(p), melody(m) {
    position = 0;
    frequency = 0;
    state = false;
    nextToggle = 0;
    noteStart = 0;
    noteDuration = 0;
  }
  
  void begin() {
    pinMode(pin, OUTPUT);
    digitalWrite(pin, LOW);
  }
  
  void update() {
    if (frequency <= 0) {
      digitalWrite(pin, LOW);
      return;
    }
    
    unsigned long now = micros();
    if ((long)(now - nextToggle) >= 0) {
      state = !state;
      digitalWrite(pin, state);
      nextToggle = now + (500000L / frequency);
    }
  }
  
  void setFrequency(int freq) {
    frequency = freq;
    if (freq <= 0) {
      digitalWrite(pin, LOW);
      state = false;
      nextToggle = 0;
    }
  }
  
  int parseNextNote() {
    // Skip spaces
    while (pgm_read_byte(&melody[position]) == ' ') position++;
    
    char c = pgm_read_byte(&melody[position]);
    
    // Check for end
    if (c == 'X') {
      position = 0; // Loop back to start
      setFrequency(0);
      noteDuration = 1000;
      return noteDuration;
    }
    
    // Read duration (1-2 digits)
    int duration = 0;
    while (c >= '0' && c <= '9') {
      duration = duration * 10 + (c - '0');
      position++;
      c = pgm_read_byte(&melody[position]);
    }
    
    // Check for silence
    if (c == 'S') {
      setFrequency(0);
      position += 2; // Skip "S " or "SX"
      noteDuration = (2656) / (4 * duration); // 83ms per quarter note at 180bpm
      return noteDuration;
    }
    
    // Parse note letter
    char noteChar = c;
    position++;
    c = pgm_read_byte(&melody[position]);
    bool isSharp = (c == 'S');
    if (isSharp) {
      position++;
      c = pgm_read_byte(&melody[position]);
    }
    
    // Parse octave
    int octave = c - '0';
    position++;
    
    // Convert to frequency index
    int baseIndex;
    switch(noteChar) {
      case 'C': baseIndex = 1; break;
      case 'D': baseIndex = 3; break;
      case 'E': baseIndex = 5; break;
      case 'F': baseIndex = 6; break;
      case 'G': baseIndex = 8; break;
      case 'A': baseIndex = 10; break;
      case 'B': baseIndex = 12; break;
      default: baseIndex = 0;
    }
    
    if (isSharp) baseIndex++;
    int noteIndex = baseIndex + ((octave - 4) * 12);
    
    if (noteIndex < 0 || noteIndex >= sizeof(NOTES)/sizeof(NOTES[0])) {
      setFrequency(0);
    } else {
      setFrequency(NOTES[noteIndex]);
    }
    
    noteDuration = (32 * 83) / (4 * duration); // 83ms per quarter note at 180bpm
    return noteDuration;
  }
  
  void checkNoteChange() {
    if (millis() - noteStart >= noteDuration) {
      parseNextNote();
      noteStart = millis();
    }
  }
};

// Create voices
Voice voice1(VOICE1_PIN, voice1_melody);
Voice voice2(VOICE2_PIN, voice2_melody);
Voice voice3(VOICE3_PIN, voice3_melody);

void setup() {
  Serial.begin(115200);
  
  // Initialize voices
  voice1.begin();
  voice2.begin();
  voice3.begin();
  
  // Parse first notes
  voice1.parseNextNote();
  voice2.parseNextNote();
  voice3.parseNextNote();
  
  voice1.noteStart = millis();
  voice2.noteStart = millis();
  voice3.noteStart = millis();
  
  Serial.println("Pokemon Battle Music - All 3 voices playing POLYPHONICALLY!");
  Serial.println("Connect pins 2, 3, 4 through 1k resistors to speaker+");
}

void loop() {
  // Update all voices simultaneously - TRUE POLYPHONY
  voice1.update();
  voice2.update();
  voice3.update();
  
  // Check if any voice needs to change notes
  voice1.checkNoteChange();
  voice2.checkNoteChange();
  voice3.checkNoteChange();
  
  // Small delay to prevent watchdog
  delayMicroseconds(10);
}